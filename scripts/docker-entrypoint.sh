#!/bin/bash
# Small script to control container behavior.

function show_help {
  printf "Used to launch CVE database.\n \
          \t-h|--help: this help menu\n\
          \t-i|--initialize: initialize database for the first time\n\
          \t-u|--update: update database\n\
          \t-r|--repopulate: repopulate database\n"
}

function update_repo {
  git pull
  pip3 install -r requirements.txt
}

function start_mongodb {
  if ! pidof -x "mongod" >/dev/null; then
    mongod &
  fi
}

function start_bash {
  printf "==> Use './bin/search.py' to query database.\n\
          ==> Use './docker-entrypoint.sh' to update\n"
  bash
}

function populate_database {
  echo "********************************************"
  ./sbin/db_mgmt.py -p
  ./sbin/db_mgmt_cpe_dictionary.py
  ./sbin/db_updater.py -c
  ./sbin/db_mgmt_ref.py
}

function update_database {
  ./sbin/db_updater.py -v
}

function repopulate_database {
  ./sbin/db_updater.py -v -f
}

# Validate number of arguments
if [ $# -eq 0 ]
  then
    show_help
    exit 0
fi

# Parse arguments
while [[ $# -gt 0 ]]
do
  key="$1"
  case $key in
      -h|--help)
      show_help
      ;;
      -i|--initialize)
      update_repo
      start_mongodb
      populate_database
      start_bash
      ;;
      -u|--update)
      update_repo
      start_mongodb
      update_database
      ;;
      -r|--repopulate)
      update_repo
      start_mongodb
      repopulate_database
      ;;
      *)
      show_help
      ;;
  esac
  shift
done

# Done!
exit 0